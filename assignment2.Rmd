# Assignment 2
## Biomedical Data Science
## B159640

This Rmarkdown document provides answers, tables and graphs for the problems 1-4 and the R code used to obtain them. It is recommended to knit the Rmarkdown to HTML to obtain the intended formatting.

### Problem 1

Loading datasets `lipids.txt` and `lipid-classes.txt` required for problem 1
```{r}
# load library to work with data tables (also for all following problems)
library(data.table)

# import file and look up files
lipids.dt <- fread("lipids.txt", stringsAsFactors = TRUE)
lipid.classes.dt <- fread("lipid-classes.txt", stringsAsFactors = TRUE)
```

#### Problem 1 (a)

Using the lipid-class lookup table `lipid.classes.dt` to determine the lipid classes
of the lipid species listed `lipids.dt`, then adding a new lipid class colum to `lipids.dt`: 

Writing a function to classify the lipids in a given data table.
It accepts as input a data table `lipid.table`, a string `lipid.species.col` that specifies the column of `lipid.table` in which the lipid species are stored and a vector `lipid.classes`:
```{r}
classify.lipids <- function(lipid.table, lipid.species.col, lipid.classes){
  
  # add  class colum to lipid.table
  lipid.table[, lipid.class := NA]
  
  # loop over over all lipid classes
  
  for(lipid in lipid.classes){
    
    # create regex that finds all lipid class identifiers
    regex <- paste0("(\\s|^)[", 
                    toupper(substr(lipid,1,1)),
                    tolower(substr(lipid,1,1)),
                    "](",
                    toupper(substr(lipid,2,nchar(lipid))),
                    "|",
                    tolower(substr(lipid,2,nchar(lipid))),
                    ")(\\s|$)")
  
    # add new col lipid.class to lipid.dt
    
    lipid.species <- paste0(lipid.table, "$" , lipid.species.col)
    lipid.table[, lipid.class := ifelse(grepl(regex, lipid.species), lipid, lipid.class)]
  }
}
```

Classifying the lipids:
```{r}
classify.lipids(lipids.dt, "lipid.species" , lipid.classes.dt$CE)
```

Checking the results:
```{r}
head(lipids.dt, n = 15)
```

Ooops, the function fails to classify lipids species containing the label "CE".
There are two possible reasons for this:

* the label "CE" and "Cer" tag Cholesterylester
* the label "CE" is the identifier of an ester not listed in `lipid.classed.dt`

A quick google search leads to the [LIPID MAPS® Lipidomics Gateway website](https://www.lipidmaps.org/tools/ms/lm_mass_form.php)
which provides access to lipid nomenclature, databases, tools, protocols and many more to serve the international lipid research community.
Here, we learn that "CE" is the identifier for lipids belonging to the class Cholesterylester.
Hence, we add this label to `lipid.classes.dt`:
```{r}
lipid.classes.dt <- rbind(lipid.classes.dt, list("CE", "Cholesterylesters"))
```

Rerunning the classification function:
```{r}
classify.lipids(lipids.dt, "lipid.species" , lipid.classes.dt$CE)
```

Checking the results (again):
```{r}
head(lipids.dt, n = 15)
```

Merging the data tables and counting the number of lipids that fall in each class
```{r}
results.dt <- merge(lipids.dt, lipid.classes.dt, 
                    by.x = "lipid.class", 
                    by.y = "CE" )

table(results.dt$`Cholesterol esters`)
```

#### Problem 1 (b)

Computing the wald test statistic for each lipid species:
```{r}
results.dt[, "wald.test" := round((oddsratio-1)/se,3)]
```

Computing a p-value for each lipid species using the t distribution and append them to `results.dt`:
(Assuming that there were 288 patients in the dataset)
```{r}
results.dt[, "p.value(t-distn)" := signif(1-(pt(abs(wald.test), 277)-pt(-abs(wald.test), 277)),3)]
```

Computing a p-value for each lipid species using the normal distribution and append them to `results.dt`:
```{r}
results.dt[, "p.value(n-distn)" := signif(1-(pnorm(abs(wald.test))-pnorm(-abs(wald.test))),3)]
```

Checking the results:
```{r}
head(results.dt)
```

Providing some evidence to justify if the normal approximation is acceptable in this instance:
```{r}
hist(results.dt$wald.test, 
     breaks = 12,
     freq=F,
     main = "Distribution of Wald test statistic",
     xlab = "Wald test statistic",
     ylab = "Frequency")

lines(density(results.dt$wald.test), col="red")

lines(seq(-8, 8, by=.05), 
      dnorm(seq(-8, 8, by=.05), mean(results.dt$wald.test), sd(results.dt$wald.test)),
      col="blue")

legend("topright", c("observed density", "normal density"), col = c("red","blue"), lty = c(1,1))
```

Comparing the observed distribution with a normal distribution, it can be stated that the observed distribution deviates from the normal distn due to a higher leftwards-shifted peak and positive skewedness. However, the normal distribution is still acceptable as a rough approximation since we only care about the extreme values (tails or the distn) when computing a p-value and evaluating whether it is above or below a certain threshold (e.g. 0.05 or 0.01).

#### Problem (c)

Implementing a function `holm.bonferroni(results.dt, alpha)` that takes as input an data.table containing the hypotheses tested and corresponding p-values (`results.dt`) and the desired significance level (`alpha`).
It computes the family-wise error rate for all hypotheses and returns `fwer.results.dt`a data table containing the subset of the tested hypothesis that are significant according to the Holm-Bonferroni method (FWER < `alpha`) ordered by increasing p-value.
```{r}
holm.bonferroni <- function(results.dt, alpha=0.05){
  
  # sorting p-values: assuming hypotheses are in the first column, p-values in the second column
  # rename columns
  colnames(results.dt) <- c('hypothesis','p.value')
  # sort results by p-value
  setorder(results.dt, cols = 'p.value')
  
  # variables
  
  m <- length(results.dt$p.value)
  k <- 1
  
  # loop over all p-values
  for (p.k in results.dt$p.value){
    
    # reject yes/no?
    if(p.k < alpha/(m+1-k)){
      #print(k)
      #print(p.k)
      k <- k + 1
    }else{
      break
    }
  }

  # subset output data table
  fwer.results.dt <- results.dt[1:k-1,]
  
  # order output data table
  setorder(fwer.results.dt, cols = 'p.value')
  
  # return result
  return(fwer.results.dt)
}
```

#### Problem (d)

Implementing a similiar function `benjamini.hochberg(results.dt, q)` that takes as input an data.table containing the hypotheses tested and corresponding p-values (`results.dt`) and and a false discovery rate `q`.
It computes the false-discovery rate for all hypotheses and returns `fdr.results.dt` a data table containing the subset of hypothesis that are significant according to the Benjamini-Hochberg method (FDR < `q`) ordered by increasing p-value.
```{r}
benjamini.hochberg <- function(results.dt, q=0.05){
  
  # sorting p-values: assuming hypotheses are in the first column, p-values in the second column
  # rename columns
  colnames(results.dt) <- c('hypothesis','p.value')
  # sort results by p-value
  setorder(results.dt, cols = 'p.value')
  
  # variables
  
  m <- length(results.dt$p.value)
  k <- 1
  
  # loop over all p-values
  for (p.k in results.dt$p.value){
    
    # reject yes/no?
    if(p.k < (k/m*q)){
      #print(k)
      #print(p.k)
      k <- k + 1
    }else{
      break
    }
  }
  
  # subset output data table
  fdr.results.dt <- results.dt[1:k-1,]
  
  # order output data table
  setorder(fdr.results.dt, cols = 'p.value')
  
  # return result
  return(fdr.results.dt)
}
``` 

#### Problem 1 (e)

Producing a volcano plot using a different 

* colour for the lipid species that are significant after controlling for the family-wise error rate at α = 0.05 
* symbol to highlight the lipid species that are considered significant according to the Benjamini-Hochberg procedure at a false discovery rate of 1%
```{r}
# creating a data table `lipids.results.dt` that only contains the lipid species tested and their corresponding p-values (t-distn)
lipids.hypotheses.dt <- results.dt[,c('lipid.species','p.value(t-distn)')]

# determining significant subsets of lipid species according to both methods at given thresholds
fwer.dt <- holm.bonferroni(lipids.hypotheses.dt, 0.05)
fdr.dt <- benjamini.hochberg(lipids.hypotheses.dt, 0.01)

#plotting results
plot(log(results.dt$oddsratio), -log10(results.dt$`p.value(t-distn)`), 
     main="Volcano plot",
     xlab="log Odds Ratio", 
     ylab="-log10(p-value)", 
     col=ifelse(results.dt$`p.value(t-distn)` %in% fwer.dt$p.value , "#FFB900FF","#008EFFFF"),
     pch=ifelse(results.dt$`p.value(t-distn)` %in% fdr.dt$p.value, 17, 19),
     cex=ifelse((results.dt$`p.value(t-distn)` %in% fdr.dt$p.value | results.dt$`p.value(t-distn)` %in% fwer.dt$`p.value(t-distn)`), 1.2, 0.5),
     xlim=c(-1,1),
     ylim=c(0,14))

# adding legend
legend("topleft", c("FWER < 5%", "FWER ≥ 5%", "FDR < 1%", "FDR ≥ 1%"), 
       col = c("#FFB900FF","#008EFFFF", "grey", "grey"),
       lwd = c(3,3,1,1),
       lty = c(1,1,NA,NA),
       pch = c(NA,NA,2,1))
```

#### Problem 1 (f)

Applying the `holm.bonferroni()` function to data table `lipids.results.dt` in order to determine the significant subsets of lipid species according to Holm-Bonferroni method:
```{r}
holm.bonferroni(lipids.hypotheses.dt, 0.05) # significance level alpha = 0.05
```

Applying the `benjamini.hochberg()` function in order to determine the significant subsets of lipid species according to the Benjamini-Hochberg procedure:
```{r}
benjamini.hochberg(lipids.hypotheses.dt, 0.05)
```

Determining the subset of lipid species that are significant according to both the Holm-Bonferroni method and the Benjamini-Hochberg procedure:
```{r}
fwer.dt <- holm.bonferroni(lipids.hypotheses.dt, 0.05)
fdr.dt <- benjamini.hochberg(lipids.hypotheses.dt, 0.05)
intersect(fwer.dt$hypothesis, fdr.dt$hypothesis)
```

### Problem 2

### Problem 3

### Problem 4